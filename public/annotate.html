<!DOCTYPE html>
<html>

<head>
  <title>Attack Flow - Annotation Editor</title>
  <link rel="stylesheet" href="/stylesheets/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <style>
    .container {
      display: flex;
      gap: 20px;
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .document-panel {
      flex: 2;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      min-height: 500px;
    }

    .sidebar {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .panel {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
    }

    .panel h3 {
      margin-top: 0;
      border-bottom: 2px solid #4a90d9;
      padding-bottom: 10px;
      color: #333;
    }

    .tag-category {
      margin-bottom: 15px;
    }

    .tag-category-header {
      font-weight: bold;
      color: #4a90d9;
      cursor: pointer;
      padding: 8px;
      background: #f5f5f5;
      border-radius: 4px;
      margin-bottom: 5px;
    }

    .tag-category-header:hover {
      background: #e8e8e8;
    }

    .tag-list {
      display: none;
      padding-left: 10px;
      max-height: 200px;
      overflow-y: auto;
    }

    .tag-list.expanded {
      display: block;
    }

    .tag-item {
      padding: 6px 10px;
      margin: 3px 0;
      background: #e8f4fd;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
    }

    .tag-item:hover {
      background: #c5e1f9;
    }

    .tag-item.selected {
      background: #4a90d9;
      color: white;
    }

    .annotation-form {
      display: none;
      margin-top: 15px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
    }

    .annotation-form.visible {
      display: block;
    }

    .annotation-form label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #555;
    }

    .annotation-form textarea,
    .annotation-form input[type="text"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 10px;
      font-family: inherit;
      box-sizing: border-box;
    }

    .annotation-form textarea {
      min-height: 80px;
      resize: vertical;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .btn-primary {
      background: #4a90d9;
      color: white;
    }

    .btn-primary:hover {
      background: #3a7bc8;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #218838;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .annotation-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .annotation-item {
      padding: 12px;
      margin-bottom: 10px;
      background: #f8f9fa;
      border-left: 4px solid #4a90d9;
      border-radius: 4px;
    }

    .annotation-item .tag-name {
      font-weight: bold;
      color: #4a90d9;
    }

    .annotation-item .selected-text {
      font-style: italic;
      color: #666;
      margin: 5px 0;
      padding: 5px;
      background: #fff;
      border-radius: 4px;
    }

    .annotation-item .note {
      font-size: 13px;
      color: #555;
    }

    .annotation-item .actions {
      margin-top: 8px;
    }

    .annotation-item .actions button {
      padding: 4px 8px;
      font-size: 12px;
      margin-right: 5px;
    }

    .document-content {
      line-height: 1.8;
      white-space: pre-wrap;
      font-family: Georgia, serif;
    }

    .highlight {
      background: #ffeb3b;
      padding: 2px 4px;
      border-radius: 2px;
      cursor: pointer;
    }

    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background: #4a90d9;
      color: white;
    }

    .header-bar h1 {
      margin: 0;
      font-size: 24px;
    }

    .header-bar a {
      color: white;
      text-decoration: none;
    }

    .file-info {
      margin-bottom: 15px;
      padding: 10px;
      background: #e8f4fd;
      border-radius: 4px;
    }

    .file-info strong {
      color: #4a90d9;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }

    .status-pending {
      background: #ffc107;
      color: #856404;
    }

    .status-approved {
      background: #28a745;
      color: white;
    }

    .status-rejected {
      background: #dc3545;
      color: white;
    }

    .generate-section {
      margin-top: 20px;
      padding: 15px;
      background: #e8f4fd;
      border-radius: 8px;
      text-align: center;
    }

    .generate-section input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }

    .no-file-message {
      text-align: center;
      padding: 50px;
      color: #666;
    }

    .selection-info {
      padding: 10px;
      background: #fff3cd;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 13px;
    }

    #selectedTextDisplay {
      font-style: italic;
      max-height: 60px;
      overflow-y: auto;
      padding: 5px;
      background: #fff;
      border-radius: 4px;
      margin-top: 5px;
    }

    .back-link {
      display: inline-block;
      margin-bottom: 15px;
      color: #4a90d9;
      text-decoration: none;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    .search-box {
      margin-bottom: 15px;
    }

    .search-box input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
  </style>
</head>

<body>
  <div class="header-bar">
    <h1><i class="fa fa-shield"></i> Attack Flow - Annotation Editor</h1>
    <a href="/home" id="homeLink"><i class="fa fa-home"></i> Back to Home</a>
  </div>

  <div id="noFileMessage" class="no-file-message" style="display: none;">
    <h2>No file selected</h2>
    <p>Please select a file from your home page to annotate.</p>
    <a href="/home" class="btn btn-primary">Go to Home</a>
  </div>

  <div id="mainContent" class="container">
    <div class="document-panel">
      <div class="file-info">
        <strong>File:</strong> <span id="fileName">Loading...</span>
        <span class="status-badge status-pending" id="statusBadge">Pending</span>
      </div>
      <div id="documentContent" class="document-content">
        Loading document content...
      </div>
    </div>

    <div class="sidebar">
      <div class="panel">
        <h3><i class="fa fa-tags"></i> MITRE ATT&CK Tags</h3>
        <div class="search-box">
          <input type="text" id="tagSearch" placeholder="Search tags..." oninput="filterTags()">
        </div>
        <div id="tagCategories">
          <!-- Tags will be loaded here -->
        </div>
      </div>

      <div class="panel">
        <h3><i class="fa fa-edit"></i> Add Annotation</h3>
        <div class="selection-info">
          <strong>Selected Text:</strong>
          <div id="selectedTextDisplay">Select text from the document to annotate</div>
        </div>
        <div id="annotationForm" class="annotation-form visible">
          <input type="hidden" id="selectedTagId">
          <label>Selected Tag:</label>
          <input type="text" id="selectedTagName" readonly placeholder="Click a tag to select">

          <label>Notes (optional):</label>
          <textarea id="annotationNote" placeholder="Add any notes about this annotation..."></textarea>

          <button class="btn btn-primary" onclick="saveAnnotation()">
            <i class="fa fa-save"></i> Save Annotation
          </button>
        </div>
      </div>

      <div class="panel">
        <h3><i class="fa fa-list"></i> Annotations (<span id="annotationCount">0</span>)</h3>
        <div id="annotationList" class="annotation-list">
          <!-- Annotations will be loaded here -->
        </div>

        <div class="generate-section">
          <h4>Generate Attack Flow</h4>
          <input type="text" id="flowName" placeholder="Attack Flow Name">
          <input type="text" id="flowDescription" placeholder="Description (optional)">
          <button class="btn btn-success" onclick="generateAttackFlow()">
            <i class="fa fa-magic"></i> Generate Attack Flow
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Get file ID from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const fileID = urlParams.get('fileID');

    let tags = [];
    let annotations = [];
    let selectedText = '';
    let startOffset = 0;
    let endOffset = 0;

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      if (!fileID) {
        document.getElementById('noFileMessage').style.display = 'block';
        document.getElementById('mainContent').style.display = 'none';
        return;
      }

      loadFileInfo();
      loadTags();
      loadAnnotations();

      // Set up text selection listener
      document.getElementById('documentContent').addEventListener('mouseup', handleTextSelection);
    });

    function loadFileInfo() {
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          const file = JSON.parse(this.responseText);

          // Parse filename
          var parts = file.fileName.split(" - ");
          var fileName = parts[0];
          document.getElementById('fileName').textContent = fileName;

          // Update status badge
          updateStatusBadge(file.status);

          // Load document content (for now, show placeholder)
          loadDocumentContent(file);
        }
      };
      xhttp.open("GET", "/file-info/" + fileID, true);
      xhttp.send();
    }

    function loadDocumentContent(file) {
      // For text files, we could fetch and display content
      // For now, show a message about the file
      var content = document.getElementById('documentContent');
      content.innerHTML = `
        <p><strong>Document:</strong> ${file.fileName.split(" - ")[0]}</p>
        <p><em>This is the annotation workspace for the uploaded incident report.</em></p>
        <hr>
        <p>To annotate this document:</p>
        <ol>
          <li>Enter or paste the relevant text excerpt in the selection area</li>
          <li>Select a MITRE ATT&CK tag from the sidebar</li>
          <li>Add optional notes</li>
          <li>Click "Save Annotation"</li>
        </ol>
        <hr>
        <p><strong>Manual Text Entry:</strong></p>
        <textarea id="manualTextInput" style="width:100%; min-height:150px; padding:10px; border:1px solid #ddd; border-radius:4px;" placeholder="Paste or type the text excerpt you want to annotate here..."></textarea>
        <button class="btn btn-secondary" onclick="useManualText()" style="margin-top:10px;">
          <i class="fa fa-check"></i> Use This Text
        </button>
      `;
    }

    function useManualText() {
      var text = document.getElementById('manualTextInput').value.trim();
      if (text) {
        selectedText = text;
        document.getElementById('selectedTextDisplay').textContent = text.substring(0, 200) + (text.length > 200 ? '...' : '');
      } else {
        alert('Please enter some text to annotate.');
      }
    }

    function handleTextSelection() {
      var selection = window.getSelection();
      var text = selection.toString().trim();

      if (text && text.length > 0) {
        selectedText = text;
        document.getElementById('selectedTextDisplay').textContent = text.substring(0, 200) + (text.length > 200 ? '...' : '');
      }
    }

    function loadTags() {
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          tags = JSON.parse(this.responseText);
          renderTags();
        }
      };
      xhttp.open("GET", "/tags", true);
      xhttp.send();
    }

    function renderTags() {
      var container = document.getElementById('tagCategories');

      // Group tags by category
      var categories = {};
      tags.forEach(function(tag) {
        if (!categories[tag.category]) {
          categories[tag.category] = [];
        }
        categories[tag.category].push(tag);
      });

      var html = '';
      for (var category in categories) {
        html += `
          <div class="tag-category" data-category="${category}">
            <div class="tag-category-header" onclick="toggleCategory('${category}')">
              <i class="fa fa-chevron-right"></i> ${category} (${categories[category].length})
            </div>
            <div class="tag-list" id="category-${category.replace(/\s+/g, '-')}">
        `;

        categories[category].forEach(function(tag) {
          var tagName = tag.name || tag.tagName;
          var techniqueID = tag.techniqueID || '';
          html += `
            <div class="tag-item" data-id="${tag.tagID}" data-name="${tagName}" onclick="selectTag(${tag.tagID}, '${tagName.replace(/'/g, "\\'")}')">
              <strong>${techniqueID}</strong>
              <br><small>${tagName}</small>
            </div>
          `;
        });

        html += `</div></div>`;
      }

      container.innerHTML = html;
    }

    function toggleCategory(category) {
      var list = document.getElementById('category-' + category.replace(/\s+/g, '-'));
      list.classList.toggle('expanded');

      var header = list.previousElementSibling;
      var icon = header.querySelector('i');
      if (list.classList.contains('expanded')) {
        icon.className = 'fa fa-chevron-down';
      } else {
        icon.className = 'fa fa-chevron-right';
      }
    }

    function filterTags() {
      var search = document.getElementById('tagSearch').value.toLowerCase();
      var items = document.querySelectorAll('.tag-item');

      items.forEach(function(item) {
        var name = (item.getAttribute('data-name') || '').toLowerCase();
        var text = item.textContent.toLowerCase();
        if (name.includes(search) || text.includes(search)) {
          item.style.display = 'block';
        } else {
          item.style.display = 'none';
        }
      });

      // Expand categories with matching items
      if (search) {
        document.querySelectorAll('.tag-list').forEach(function(list) {
          var hasVisible = Array.from(list.querySelectorAll('.tag-item')).some(function(item) {
            return item.style.display !== 'none';
          });
          if (hasVisible) {
            list.classList.add('expanded');
            var icon = list.previousElementSibling.querySelector('i');
            icon.className = 'fa fa-chevron-down';
          }
        });
      }
    }

    function selectTag(tagId, tagName) {
      // Remove selection from other tags
      document.querySelectorAll('.tag-item').forEach(function(item) {
        item.classList.remove('selected');
      });

      // Select this tag
      document.querySelector(`.tag-item[data-id="${tagId}"]`).classList.add('selected');

      document.getElementById('selectedTagId').value = tagId;
      document.getElementById('selectedTagName').value = tagName;
    }

    function loadAnnotations() {
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          annotations = JSON.parse(this.responseText);
          renderAnnotations();
        }
      };
      xhttp.open("GET", "/annotations?fileID=" + fileID, true);
      xhttp.send();
    }

    function renderAnnotations() {
      var container = document.getElementById('annotationList');
      document.getElementById('annotationCount').textContent = annotations.length;

      if (annotations.length === 0) {
        container.innerHTML = '<p style="color:#666; text-align:center;">No annotations yet</p>';
        return;
      }

      var html = '';
      annotations.forEach(function(ann) {
        html += `
          <div class="annotation-item" data-id="${ann.annotationID}">
            <div class="tag-name">${ann.tagName || 'Unknown Tag'}</div>
            <div class="selected-text">"${ann.selectedText.substring(0, 100)}${ann.selectedText.length > 100 ? '...' : ''}"</div>
            ${ann.note ? `<div class="note"><strong>Note:</strong> ${ann.note}</div>` : ''}
            <div class="actions">
              <button class="btn btn-danger" onclick="deleteAnnotation(${ann.annotationID})">
                <i class="fa fa-trash"></i> Delete
              </button>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function saveAnnotation() {
      var tagId = document.getElementById('selectedTagId').value;
      var note = document.getElementById('annotationNote').value;

      if (!selectedText) {
        alert('Please select or enter some text to annotate.');
        return;
      }

      if (!tagId) {
        alert('Please select a MITRE ATT&CK tag.');
        return;
      }

      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4) {
          if (this.status == 201) {
            // Clear form
            selectedText = '';
            document.getElementById('selectedTextDisplay').textContent = 'Select text from the document to annotate';
            document.getElementById('annotationNote').value = '';
            document.getElementById('selectedTagId').value = '';
            document.getElementById('selectedTagName').value = '';
            document.querySelectorAll('.tag-item').forEach(function(item) {
              item.classList.remove('selected');
            });

            // Reload annotations
            loadAnnotations();

            alert('Annotation saved successfully!');
          } else {
            alert('Error saving annotation. Please try again.');
          }
        }
      };

      xhttp.open("POST", "/annotations", true);
      xhttp.setRequestHeader("Content-Type", "application/json");
      xhttp.send(JSON.stringify({
        fileID: fileID,
        tagID: tagId,
        selectedText: selectedText,
        note: note,
        startOffset: 0,
        endOffset: selectedText.length
      }));
    }

    function deleteAnnotation(annotationId) {
      if (!confirm('Are you sure you want to delete this annotation?')) {
        return;
      }

      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4) {
          if (this.status == 200) {
            loadAnnotations();
          } else {
            alert('Error deleting annotation.');
          }
        }
      };
      xhttp.open("DELETE", "/annotations/" + annotationId, true);
      xhttp.send();
    }

    function generateAttackFlow() {
      var name = document.getElementById('flowName').value.trim();
      var description = document.getElementById('flowDescription').value.trim();

      if (!name) {
        alert('Please enter a name for the Attack Flow.');
        return;
      }

      if (annotations.length === 0) {
        alert('Please add at least one annotation before generating an Attack Flow.');
        return;
      }

      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4) {
          if (this.status == 201) {
            var response = JSON.parse(this.responseText);
            alert('Attack Flow generated successfully! Flow ID: ' + response.flowID);

            // Update status
            updateStatusBadge('pending_review');

            // Offer to download
            if (confirm('Would you like to download the Attack Flow JSON?')) {
              downloadAttackFlow(response.flowID);
            }
          } else {
            var error = JSON.parse(this.responseText);
            alert('Error generating Attack Flow: ' + (error.error || 'Unknown error'));
          }
        }
      };

      xhttp.open("POST", "/generate-attack-flow", true);
      xhttp.setRequestHeader("Content-Type", "application/json");
      xhttp.send(JSON.stringify({
        fileID: fileID,
        name: name,
        description: description
      }));
    }

    function downloadAttackFlow(flowID) {
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          var response = JSON.parse(this.responseText);

          // Create download link
          var a = document.createElement('a');
          a.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(response.attackFlowJSON);
          a.download = 'attack-flow-' + flowID + '.json';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }
      };
      xhttp.open("GET", "/attack-flow/" + flowID, true);
      xhttp.send();
    }

    function updateStatusBadge(status) {
      var badge = document.getElementById('statusBadge');
      badge.className = 'status-badge';

      switch(status) {
        case 'approved':
          badge.classList.add('status-approved');
          badge.textContent = 'Approved';
          break;
        case 'rejected':
          badge.classList.add('status-rejected');
          badge.textContent = 'Rejected';
          break;
        case 'pending_review':
          badge.classList.add('status-pending');
          badge.textContent = 'Pending Review';
          break;
        default:
          badge.classList.add('status-pending');
          badge.textContent = 'Pending';
      }
    }
  </script>
</body>

</html>
