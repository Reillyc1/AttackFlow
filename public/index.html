<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attack Flow - Login</title>
  <link rel="stylesheet" href="/stylesheets/style.css">
</head>

<body>
  <h1>Attack Flow</h1>
  <p>This is a tool to generate and validate attack flows from provided incident reports.</p>

  <div class="login">
    <form name="login" class="center" onSubmit="handleLogin(event)">

      <section class="login-section">
        <input type="text" id="username" placeholder="Enter Username" name="username" required
               minlength="3" maxlength="64" autocomplete="username">
      </section>

      <section class="login-section">
        <input type="password" id="password" placeholder="Enter Password" name="password" required
               minlength="6" maxlength="128" autocomplete="current-password">
      </section>

      <section class="login-button">
        <input type="submit" value="Login" id="loginBtn">
      </section>

      <div id="error-message" class="error-message" style="display: none;"></div>

    </form>
  </div>

  <div class="create-account">
    <a href="create-account.html">Create Account</a>
  </div>

  <script>
    /**
     * Handles the login form submission
     * Sends credentials to the server and handles the response
     *
     * @param {Event} event - The form submit event
     */
    function handleLogin(event) {
      event.preventDefault();

      const usernameInput = document.getElementById('username');
      const passwordInput = document.getElementById('password');
      const loginBtn = document.getElementById('loginBtn');
      const errorDiv = document.getElementById('error-message');

      // Get and sanitize input values
      const username = usernameInput.value.trim();
      const password = passwordInput.value;

      // Client-side validation (defense in depth - server also validates)
      if (!username || username.length < 3) {
        showError('Username must be at least 3 characters');
        return;
      }

      if (!password || password.length < 6) {
        showError('Password must be at least 6 characters');
        return;
      }

      // Disable button during request to prevent double-submission
      loginBtn.disabled = true;
      loginBtn.value = 'Logging in...';
      hideError();

      // Send login request
      fetch('/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          username: username,
          password: password
        }),
        credentials: 'same-origin' // Include session cookies
      })
      .then(function(response) {
        if (response.status === 204) {
          // Login successful, check user role for redirect
          return checkUserRedirect();
        } else if (response.status === 429) {
          // Rate limited
          return response.json().then(function(data) {
            throw new Error(data.message || 'Too many login attempts. Please try again later.');
          });
        } else {
          // Login failed
          return response.json().then(function(data) {
            throw new Error(data.message || 'Invalid username or password');
          });
        }
      })
      .catch(function(error) {
        showError(error.message || 'An error occurred during login');
        loginBtn.disabled = false;
        loginBtn.value = 'Login';
      });
    }

    /**
     * Checks the user's role and redirects to the appropriate dashboard
     */
    function checkUserRedirect() {
      return fetch('/redirect', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
      })
      .then(function(response) {
        if (response.ok) {
          return response.json();
        }
        throw new Error('Failed to determine user role');
      })
      .then(function(data) {
        if (data.redirectTo) {
          window.location.href = data.redirectTo;
        } else {
          throw new Error('No redirect URL provided');
        }
      });
    }

    /**
     * Displays an error message to the user
     *
     * @param {string} message - The error message to display
     */
    function showError(message) {
      const errorDiv = document.getElementById('error-message');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }

    /**
     * Hides the error message
     */
    function hideError() {
      const errorDiv = document.getElementById('error-message');
      errorDiv.style.display = 'none';
    }
  </script>

</body>

</html>
